#!/bin/bash

# 1. Get the filename
FILENAME="$1"

# Check if you forgot the filename
if [ -z "$FILENAME" ]; then
  echo "Usage: ./hack <filename>"
  exit 1
fi

# Find the absolute path
FILEPATH=$(realpath "$FILENAME")

# Check if file exists
if [ ! -f "$FILEPATH" ]; then
    echo "Error: Cannot find '$FILENAME' here."
    exit 1
fi

# 2. Wake up the container
echo "Wake up, IDA..."
sudo docker start idapro > /dev/null 2>&1

# 3. Create the main newME folder if it doesn't exist
sudo docker exec idapro mkdir -p /root/newME

# 4. Calculate the Next ID (Auto-Increment 1, 2, 3...)
# It counts how many items are in newME and adds 1.
COUNT=$(sudo docker exec idapro sh -c "ls -1 /root/newME | wc -l")
NEXT_ID=$((COUNT + 1))

echo "Creating Project #$NEXT_ID..."

# 5. Make the numbered folder inside container
# Example: /root/newME/1/
sudo docker exec idapro mkdir -p /root/newME/$NEXT_ID

# 6. Copy the file into that specific numbered folder
echo "Copying to /root/newME/$NEXT_ID/..."
sudo docker cp "$FILEPATH" idapro:/root/newME/$NEXT_ID/

# 7. Launch IDA pointing to the clean location
echo "Launching IDA..."
cd ~/IDAproject/idapro-docker
# Note the path: Z:\root\newME\<ID>\<filename>
./ida.sh ida "Z:\\root\\newME\\$NEXT_ID\\$(basename "$FILENAME")"
